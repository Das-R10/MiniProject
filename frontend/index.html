<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LexAnalyze ‚Äî Legal Clause Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg: #060910;
      --surface: #0d1117;
      --surface2: #131920;
      --border: rgba(255,255,255,0.06);
      --border-glow: rgba(99,179,237,0.2);
      --accent: #63b3ed;
      --accent2: #4fd1c5;
      --gold: #f6c90e;
      --con: #fc5c65;
      --pro: #26de81;
      --neutral: #778ca3;
      --text: #e2eaf4;
      --muted: #5a7184;
      --radius: 12px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      overflow-x: hidden;
    }

    /* Subtle grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(99,179,237,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99,179,237,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    /* Glow orb */
    body::after {
      content: '';
      position: fixed;
      top: -200px;
      right: -200px;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(99,179,237,0.06) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .layout {
      position: relative;
      z-index: 1;
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr 380px;
      grid-template-rows: auto 1fr;
      gap: 20px;
      min-height: 100vh;
    }

    /* ===== HEADER ===== */
    .header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      animation: fadeDown 0.5s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-box {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border-glow);
      flex-shrink: 0;
    }

    .logo-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .brand-text h1 {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    .brand-text p {
      color: var(--muted);
      font-size: 12px;
      margin-top: 2px;
      font-weight: 300;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .lang-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      cursor: pointer;
      outline: none;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--pro);
      box-shadow: 0 0 8px var(--pro);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* ===== MAIN PANEL ===== */
    .main-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      animation: fadeUp 0.5s ease 0.1s both;
    }

    /* ===== UPLOAD ZONE ===== */
    .upload-zone {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .upload-inner {
      display: flex;
      gap: 0;
    }

    .drop-area {
      flex: 1;
      padding: 32px 28px;
      cursor: pointer;
      transition: background 0.2s;
      border-right: 1px solid var(--border);
      position: relative;
    }

    .drop-area:hover {
      background: rgba(99,179,237,0.03);
    }

    .drop-area.dragover {
      background: rgba(99,179,237,0.06);
      border-color: var(--accent);
    }

    .drop-icon {
      font-size: 32px;
      margin-bottom: 10px;
      display: block;
    }

    .drop-title {
      font-family: 'Playfair Display', serif;
      font-size: 17px;
      color: var(--text);
      margin-bottom: 6px;
    }

    .drop-hint {
      font-size: 12px;
      color: var(--muted);
      font-weight: 300;
    }

    .file-name-badge {
      display: none;
      margin-top: 10px;
      padding: 6px 10px;
      background: rgba(99,179,237,0.1);
      border: 1px solid rgba(99,179,237,0.2);
      border-radius: 6px;
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      color: var(--accent);
    }

    .upload-actions {
      width: 220px;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      justify-content: center;
    }

    input[type=file] { display: none; }

    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      color: #060910;
      font-weight: 700;
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(99,179,237,0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== PROGRESS ===== */
    .progress-bar {
      display: none;
      height: 3px;
      background: var(--surface2);
      overflow: hidden;
    }

    .progress-bar.active {
      display: block;
    }

    .progress-fill {
      height: 100%;
      width: 30%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      animation: progressSlide 1.5s ease-in-out infinite;
    }

    @keyframes progressSlide {
      0% { transform: translateX(-200%); }
      100% { transform: translateX(500%); }
    }

    /* ===== STATS BAR ===== */
    .stats-bar {
      display: none;
      padding: 14px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      flex-direction: row;
      align-items: center;
      gap: 24px;
    }

    .stats-bar.visible { display: flex; }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stat-value {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .stat-divider {
      width: 1px;
      height: 32px;
      background: var(--border);
    }

    .stat-con { color: var(--con); }
    .stat-pro { color: var(--pro); }
    .stat-neutral { color: var(--neutral); }

    .stats-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .btn-sm {
      padding: 7px 12px;
      font-size: 12px;
      border-radius: 6px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

    .btn-outline-con {
      background: transparent;
      border: 1px solid rgba(252,92,101,0.3);
      color: var(--con);
    }

    .btn-outline-con:hover { background: rgba(252,92,101,0.08); }

    .btn-outline-pro {
      background: transparent;
      border: 1px solid rgba(38,222,129,0.3);
      color: var(--pro);
    }

    .btn-outline-pro:hover { background: rgba(38,222,129,0.08); }

    /* ===== CLAUSE CARDS ===== */
    .results-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .clause-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
      animation: fadeUp 0.3s ease both;
    }

    .clause-card:hover {
      border-color: rgba(99,179,237,0.2);
      transform: translateY(-1px);
    }

    .clause-card.con { border-left: 3px solid var(--con); }
    .clause-card.pro { border-left: 3px solid var(--pro); }
    .clause-card.neutral { border-left: 3px solid var(--neutral); }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      user-select: none;
    }

    .card-header:hover { background: rgba(255,255,255,0.01); }

    .clause-num {
      font-family: 'DM Mono', monospace;
      font-size: 13px;
      color: var(--muted);
      min-width: 36px;
    }

    .clause-section-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--surface2);
      color: var(--muted);
      border: 1px solid var(--border);
      font-weight: 500;
      white-space: nowrap;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .label-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .label-badge.con { background: rgba(252,92,101,0.15); color: var(--con); border: 1px solid rgba(252,92,101,0.3); }
    .label-badge.pro { background: rgba(38,222,129,0.15); color: var(--pro); border: 1px solid rgba(38,222,129,0.3); }
    .label-badge.neutral { background: rgba(119,140,163,0.15); color: var(--neutral); border: 1px solid rgba(119,140,163,0.3); }

    .conf-bar-wrap {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conf-pct {
      font-family: 'DM Mono', monospace;
      font-size: 12px;
      color: var(--muted);
      min-width: 34px;
      text-align: right;
    }

    .conf-bar {
      width: 60px;
      height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      overflow: hidden;
    }

    .conf-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .conf-fill.con { background: var(--con); }
    .conf-fill.pro { background: var(--pro); }
    .conf-fill.neutral { background: var(--neutral); }

    .chevron {
      color: var(--muted);
      font-size: 16px;
      transition: transform 0.2s;
      margin-left: 4px;
    }

    .chevron.open { transform: rotate(180deg); }

    .card-body {
      display: none;
      padding: 0 16px 16px 16px;
      border-top: 1px solid var(--border);
      animation: fadeUp 0.2s ease;
    }

    .card-body.open { display: block; }

    .clause-text-block {
      margin-top: 12px;
      padding: 12px;
      background: var(--surface2);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      line-height: 1.7;
      color: #a8c5da;
      font-family: 'DM Mono', monospace;
    }

    .amendment-block {
      margin-top: 10px;
      padding: 12px;
      background: rgba(38,222,129,0.04);
      border-radius: 8px;
      border: 1px solid rgba(38,222,129,0.15);
    }

    .amendment-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--pro);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 6px;
    }

    .amendment-text {
      font-size: 13px;
      color: #c8f5e1;
      line-height: 1.6;
    }

    .translated-block {
      margin-top: 10px;
      padding: 12px;
      background: rgba(99,179,237,0.04);
      border-radius: 8px;
      border: 1px solid rgba(99,179,237,0.15);
    }

    .translated-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 6px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .action-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(99,179,237,0.05); }

    /* ===== CHAT PANEL ===== */
    .chat-panel {
      position: sticky;
      top: 20px;
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      animation: fadeUp 0.5s ease 0.2s both;
    }

    .chat-head {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .chat-title {
      font-family: 'Playfair Display', serif;
      font-size: 15px;
      color: var(--text);
    }

    .chat-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
      font-weight: 300;
    }

    .chat-head-actions { display: flex; gap: 6px; }

    .icon-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 5px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s;
    }

    .icon-btn:hover { border-color: var(--accent); color: var(--accent); }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .chat-messages::-webkit-scrollbar { width: 4px; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .msg {
      max-width: 85%;
      padding: 10px 13px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.55;
      animation: fadeUp 0.2s ease;
    }

    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #060910;
      font-weight: 500;
      border-radius: 10px 10px 2px 10px;
    }

    .msg.bot {
      align-self: flex-start;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px 10px 10px 2px;
    }

    .msg.thinking {
      align-self: flex-start;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-style: italic;
    }

    .msg.evidence {
      align-self: flex-start;
      background: rgba(99,179,237,0.04);
      border: 1px solid rgba(99,179,237,0.12);
      color: var(--muted);
      font-size: 12px;
      border-radius: 8px;
      max-width: 95%;
    }

    .evidence-ref {
      font-family: 'DM Mono', monospace;
      color: var(--accent);
      font-size: 11px;
      margin-bottom: 4px;
    }

    .quick-pills {
      padding: 10px 16px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      background: var(--surface2);
      flex-shrink: 0;
    }

    .pill {
      padding: 5px 11px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      font-family: 'DM Sans', sans-serif;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .pill:hover { border-color: var(--accent); color: var(--accent); background: rgba(99,179,237,0.05); }

    .chat-input-row {
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .chat-input-field {
      flex: 1;
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input-field:focus { border-color: var(--accent); }
    .chat-input-field::placeholder { color: var(--muted); }

    .send-btn {
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      border-radius: 8px;
      color: #060910;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .send-btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }

    .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
    .empty-title { font-family: 'Playfair Display', serif; font-size: 16px; color: var(--text); margin-bottom: 6px; }
    .empty-sub { font-size: 12px; font-weight: 300; }

    /* ===== ANIMATIONS ===== */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      .chat-panel { position: relative; top: 0; height: 500px; }
    }

    @media (max-width: 600px) {
      .layout { padding: 12px; gap: 12px; }
      .upload-inner { flex-direction: column; }
      .upload-actions { width: 100%; padding: 16px; flex-direction: row; flex-wrap: wrap; }
    }
  </style>
</head>
<body>
<div class="layout">

  <!-- HEADER -->
  <header class="header">
    <div class="brand">
      <div class="logo-box">
        <img src="/static/logo.png" alt="LexAnalyze"/>
      </div>
      <div class="brand-text">
        <h1>LexAnalyze</h1>
        <p>Legal Clause Intelligence Platform</p>
      </div>
    </div>
    <div class="header-right">
      <select id="langSelect" class="lang-select">
        <option value="">English</option>
        <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
        <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
        <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
      </select>
      <div class="status-dot" title="Server online"></div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main-panel">

    <!-- UPLOAD -->
    <div class="upload-zone">
      <div class="upload-inner">
        <div class="drop-area" id="dropzone">
          <span class="drop-icon">‚öñÔ∏è</span>
          <div class="drop-title">Drop your contract here</div>
          <div class="drop-hint">PDF or TXT ¬∑ Processing takes 10‚Äì30s on CPU</div>
          <div class="file-name-badge" id="fileNameBadge"></div>
        </div>
        <div class="upload-actions">
          <input type="file" id="fileInput" accept=".pdf,.txt"/>
          <button class="btn btn-ghost" id="chooseBtn">üìÇ Choose File</button>
          <button class="btn btn-primary" id="uploadBtn">Analyze Contract ‚Üí</button>
        </div>
      </div>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill"></div>
      </div>
    </div>

    <!-- STATS BAR -->
    <div class="stats-bar" id="statsBar">
      <div class="stat-item">
        <span class="stat-value" id="statTotal" style="color:var(--accent)">0</span>
        <span class="stat-label">Total Clauses</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <span class="stat-value stat-con" id="statCon">0</span>
        <span class="stat-label">Risky</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <span class="stat-value stat-pro" id="statPro">0</span>
        <span class="stat-label">Favorable</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat-item">
        <span class="stat-value stat-neutral" id="statNeutral">0</span>
        <span class="stat-label">Neutral</span>
      </div>
      <div class="stats-actions">
        <button class="btn-sm btn-outline-con" id="filterCon">‚ö† Risks only</button>
        <button class="btn-sm btn-outline-pro" id="filterPro">‚úì Favorable only</button>
        <button class="btn-sm btn-outline" id="filterAll">All</button>
        <button class="btn-sm btn-outline" id="downloadJson">‚Üì JSON</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="results-list" id="resultsList">
      <div class="empty-state" id="emptyState">
        <div class="empty-icon">üìÑ</div>
        <div class="empty-title">No document loaded</div>
        <div class="empty-sub">Upload a contract PDF or TXT to begin analysis</div>
      </div>
    </div>

  </main>

  <!-- CHAT -->
  <aside class="chat-panel">
    <div class="chat-head">
      <div>
        <div class="chat-title">Legal Assistant</div>
        <div class="chat-subtitle">Ask questions about your document</div>
      </div>
      <div class="chat-head-actions">
        <button class="icon-btn" id="speakAnswer" title="Read last answer">üîä</button>
        <button class="icon-btn" id="clearChat" title="Clear chat">‚úï</button>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="quick-pills">
      <button class="pill" id="quick1">‚ö† Summarize risks</button>
      <button class="pill" id="quick2">‚úì Pro clauses</button>
      <button class="pill" id="quick3">üìã Termination terms</button>
    </div>
    <div class="chat-input-row">
      <input class="chat-input-field" id="chatInput" placeholder="Ask about any clause‚Ä¶"/>
      <button class="send-btn" id="chatSend">Send</button>
    </div>
  </aside>

</div>

<script>
(function(){
  // DOM refs
  const dropzone    = document.getElementById('dropzone');
  const fileInput   = document.getElementById('fileInput');
  const chooseBtn   = document.getElementById('chooseBtn');
  const uploadBtn   = document.getElementById('uploadBtn');
  const progressBar = document.getElementById('progressBar');
  const statsBar    = document.getElementById('statsBar');
  const resultsList = document.getElementById('resultsList');
  const emptyState  = document.getElementById('emptyState');
  const fileNameBadge = document.getElementById('fileNameBadge');
  const chatMessages  = document.getElementById('chatMessages');
  const chatInput     = document.getElementById('chatInput');
  const chatSend      = document.getElementById('chatSend');
  const clearChat     = document.getElementById('clearChat');
  const speakAnswerBtn = document.getElementById('speakAnswer');

  let lastData = null;
  let lastAnswer = '';
  let currentFilter = 'all';

  // ===== UPLOAD HANDLERS =====
  chooseBtn.addEventListener('click', () => fileInput.click());
  dropzone.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', () => {
    const f = fileInput.files[0];
    if (f) {
      fileNameBadge.textContent = f.name;
      fileNameBadge.style.display = 'inline-block';
    }
  });

  dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
  dropzone.addEventListener('drop', e => {
    e.preventDefault(); dropzone.classList.remove('dragover');
    const f = e.dataTransfer.files[0];
    if (f) {
      fileNameBadge.textContent = f.name;
      fileNameBadge.style.display = 'inline-block';
      // set to input for upload
      const dt = new DataTransfer(); dt.items.add(f);
      fileInput.files = dt.files;
    }
  });

  uploadBtn.addEventListener('click', () => {
    if (!fileInput.files.length) { alert('Please choose a file first.'); return; }
    doUpload(fileInput.files[0]);
  });

  async function doUpload(file) {
    uploadBtn.disabled = true;
    progressBar.classList.add('active');
    resultsList.innerHTML = '';
    statsBar.classList.remove('visible');

    const fd = new FormData(); fd.append('file', file);
    try {
      const res = await fetch('/upload', { method: 'POST', body: fd });
      if (!res.ok) throw new Error('Upload failed');
      const data = await res.json();
      lastData = data;
      renderStats(data);
      renderResults(data.results, 'all');
      appendMsg('Document analyzed! Ask me anything about the clauses.', 'bot');
    } catch(e) {
      console.error(e);
      alert('Upload failed ‚Äî check server logs.');
    } finally {
      uploadBtn.disabled = false;
      progressBar.classList.remove('active');
    }
  }

  // ===== STATS =====
  function renderStats(data) {
    const con = data.results.filter(r => r.label === 'Con').length;
    const pro = data.results.filter(r => r.label === 'Pro').length;
    const neu = data.results.filter(r => r.label === 'Neutral').length;
    document.getElementById('statTotal').textContent = data.num_clauses;
    document.getElementById('statCon').textContent = con;
    document.getElementById('statPro').textContent = pro;
    document.getElementById('statNeutral').textContent = neu;
    statsBar.classList.add('visible');
  }

  // ===== FILTER BUTTONS =====
  document.getElementById('filterCon').addEventListener('click', () => { currentFilter='con'; renderResults(lastData.results,'con'); });
  document.getElementById('filterPro').addEventListener('click', () => { currentFilter='pro'; renderResults(lastData.results,'pro'); });
  document.getElementById('filterAll').addEventListener('click', () => { currentFilter='all'; renderResults(lastData.results,'all'); });
  document.getElementById('downloadJson').addEventListener('click', () => { if(lastData) downloadJSON(lastData); });

  // ===== RENDER RESULTS =====
  function renderResults(results, filter) {
    resultsList.innerHTML = '';
    const filtered = filter === 'all' ? results : results.filter(r => r.label.toLowerCase() === filter);

    if (!filtered.length) {
      resultsList.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">No ${filter} clauses found</div></div>`;
      return;
    }

    filtered.forEach((r, idx) => {
      const card = document.createElement('div');
      card.className = `clause-card ${r.label.toLowerCase()}`;
      card.style.animationDelay = `${idx * 30}ms`;

      const conf = Math.round(r.confidence * 100);

      card.innerHTML = `
        <div class="card-header" data-id="${r.clause_id}">
          <span class="clause-num">#${r.clause_id}</span>
          <span class="clause-section-tag">${r.section || 'Unknown'}</span>
          <span class="label-badge ${r.label.toLowerCase()}">${r.label}</span>
          <div class="conf-bar-wrap">
            <span class="conf-pct">${conf}%</span>
            <div class="conf-bar">
              <div class="conf-fill ${r.label.toLowerCase()}" style="width:${conf}%"></div>
            </div>
          </div>
          <span class="chevron">‚ñæ</span>
        </div>
        <div class="card-body" id="body-${r.clause_id}">
          <div class="clause-text-block">${escHtml(r.original || '')}</div>
          ${r.amended ? `<div class="amendment-block"><div class="amendment-label">‚ú¶ Suggested Amendment</div><div class="amendment-text">${escHtml(r.amended)}</div></div>` : ''}
          <div id="translated-${r.clause_id}"></div>
          <div class="card-actions">
            <button class="action-btn translate-btn">üåê Translate</button>
            <button class="action-btn speak-btn">üîä Read Aloud</button>
            <button class="action-btn ask-btn">üí¨ Ask About</button>
          </div>
        </div>
      `;

      // toggle collapse
      card.querySelector('.card-header').addEventListener('click', () => {
        const body = card.querySelector('.card-body');
        const chev = card.querySelector('.chevron');
        body.classList.toggle('open');
        chev.classList.toggle('open');
      });

      // Translate button
      card.querySelector('.translate-btn').addEventListener('click', async function() {
        const lang = document.getElementById('langSelect').value;
        if (!lang) { alert('Select a target language in the header first.'); return; }
        this.textContent = '‚è≥ Translating‚Ä¶'; this.disabled = true;
        try {
          const res = await fetch('/translate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text: r.original, target: lang}) });
          const d = await res.json();
          document.getElementById('translated-' + r.clause_id).innerHTML =
            '<div class="translated-block"><div class="translated-label">üåê Translation</div><div style="font-size:13px;line-height:1.6;color:#a8d8ea">' + escHtml(d.translatedText) + '</div></div>';
        } catch(e) { alert('Translation failed'); }
        finally { this.textContent = 'üåê Translate'; this.disabled = false; }
      });

      // Speak button
      card.querySelector('.speak-btn').addEventListener('click', () => speakText(r.original));

      // Ask About button
      card.querySelector('.ask-btn').addEventListener('click', () => {
        const q = 'Explain clause ' + r.clause_id + ' and its implications for the employee.';
        appendMsg(escHtml(q), 'user');
        sendQuestion(q);
        chatMessages.scrollIntoView({ behavior: 'smooth' });
      });

      resultsList.appendChild(card);
    });
  }

  // Clause actions are handled via event listeners inside renderResults

  // ===== DOWNLOAD =====
  function downloadJSON(data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'lexanalyze-results.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ===== CHAT =====
  function appendMsg(html, who) {
    const d = document.createElement('div');
    d.className = `msg ${who}`;
    d.innerHTML = html;
    chatMessages.appendChild(d);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return d;
  }

  async function sendQuestion(q) {
    if (!q) return;
    const thinking = appendMsg('<em>Thinking‚Ä¶</em>', 'thinking');
    try {
      const res = await fetch('/qa', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({question: q}) });
      const data = await res.json();
      chatMessages.removeChild(thinking);
      if (!data.answer) { appendMsg('No relevant information found in the document.', 'bot'); return; }
      lastAnswer = data.answer;
      appendMsg(`<strong>${escHtml(data.answer)}</strong>`, 'bot');
      (data.evidence || []).forEach(ev => {
        const e = document.createElement('div');
        e.className = 'msg evidence';
        e.innerHTML = `<div class="evidence-ref">Ref ¬ß${ev.clause_id} ¬∑ ${Math.round(ev.score*100)}% match</div><div>${escHtml(truncate(ev.text, 200))}</div>`;
        chatMessages.appendChild(e);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } catch(e) { chatMessages.removeChild(thinking); appendMsg('Error contacting server.', 'bot'); }
  }

  chatSend.addEventListener('click', () => {
    const q = chatInput.value.trim(); if (!q) return;
    appendMsg(escHtml(q), 'user'); chatInput.value = ''; sendQuestion(q);
  });

  chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') chatSend.click(); });

  clearChat.addEventListener('click', () => {
    chatMessages.innerHTML = '';
    appendMsg('Chat cleared. Upload a document and ask me anything about it.', 'bot');
  });

  speakAnswerBtn.addEventListener('click', () => { if (lastAnswer) speakText(lastAnswer); });

  // Quick pills
  document.getElementById('quick1').addEventListener('click', () => {
    if (!lastData) { alert('Upload a document first'); return; }
    const hits = lastData.results.filter(r => r.label === 'Con');
    const q = hits.length ? 'Summarize the main risks: ' + hits.map(r=>`Clause ${r.clause_id}: ${truncate(r.original,120)}`).join(' | ') : 'No risky clauses found.';
    appendMsg('‚ö† Summarize risks', 'user'); sendQuestion(q);
  });

  document.getElementById('quick2').addEventListener('click', () => {
    if (!lastData) { alert('Upload a document first'); return; }
    const hits = lastData.results.filter(r => r.label === 'Pro');
    const q = hits.length ? 'List the favorable clauses: ' + hits.map(r=>`Clause ${r.clause_id}: ${truncate(r.original,120)}`).join(' | ') : 'No favorable clauses found.';
    appendMsg('‚úì Favorable clauses', 'user'); sendQuestion(q);
  });

  document.getElementById('quick3').addEventListener('click', () => {
    if (!lastData) { alert('Upload a document first'); return; }
    appendMsg('üìã Termination terms', 'user'); sendQuestion('What are the termination terms and conditions in this contract?');
  });

  // ===== TTS =====
  async function speakText(text) {
    try {
      const lang = document.getElementById('langSelect').value || 'en';
      const res = await fetch('/tts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text, lang}) });
      if (!res.ok) throw new Error();
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
      audio.onended = () => URL.revokeObjectURL(url);
    } catch(e) { alert('Audio unavailable'); }
  }

  // ===== UTILS =====
  function escHtml(t) {
    if (!t) return '';
    return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  function truncate(s, n) { return s && s.length > n ? s.slice(0, n) + '‚Ä¶' : s; }

  // Initial greeting
  appendMsg('Hello! Upload a contract to get started. I\'ll identify risky clauses, suggest amendments, and answer your questions.', 'bot');

})();
</script>
</body>
</html>