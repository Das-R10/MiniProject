<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Legal Clause Analyzer ‚Äî Chat Assistant</title>
  <style>
    :root{
      --bg:#0a0a0a;             /* near black */
      --card:#121212;           /* dark card */
      --muted:#9ca3af;          /* muted gray */
      --accent:#f59e0b;         /* orange */
      --accent-2:#fb923c;       /* light orange */
      --ok:#22c55e;
      --danger:#ef4444;
      --glass: rgba(255,255,255,0.04);
      --radius:14px;
      --maxw:1100px;
    }

    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#071023);color:#e6eefc}
    .app{max-width:var(--maxw);margin:18px auto;padding:16px;display:grid;grid-template-columns:1fr 360px;gap:18px}

    header{display:flex;align-items:center;gap:12px}
    .logo {
      width: 70px;
      height: 70px;
      min-width: 70px;
      border-radius: 14px;
      overflow: hidden;              /* üî• prevents overflow */
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;       /* remove gradient if using full image */
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;             /* üî• keeps perfect square */
      border-radius: 14px;
    }

    h1{margin:0;font-size:20px}
    .lead{color:var(--muted);margin-top:4px;font-size:13px}

    /* main card */
    .panel{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}

    /* upload area */
    .uploader{display:flex;gap:12px;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px dashed rgba(255,255,255,0.04)}
    .drop{flex:1;padding:18px;min-height:110px;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;cursor:pointer}
    .drop p{margin:0;color:#dbeafe;font-weight:600}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}

    .right-actions{width:260px;display:flex;flex-direction:column;gap:10px}
    input[type=file]{display:none}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#e06b0b);border:none;color:#04263a}

    /* results */
    .results{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .summary{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.02)}

    .clause-card{display:flex;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02)}
    .clause-meta{width:110px;text-align:center}
    .clause-id{font-weight:800;font-size:18px}
    .clause-section{color:var(--muted);font-size:12px;margin-top:6px}
    .clause-body{flex:1}
    .label{display:inline-block;padding:6px 10px;border-radius:8px;font-weight:700;color:#051323}
    .label.neutral{background:#94a3b8}
    .label.pro{background:var(--ok)}
    .label.con{background:var(--danger)}

    .amend{margin-top:8px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.02);color:var(--muted)}

    /* tools */
    .tools{display:flex;gap:8px;margin-top:10px}
    .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}

    /* right chat */
    .chat-wrap{position:sticky;top:18px;height:calc(100vh - 36px);display:flex;flex-direction:column}
    .chat-panel{flex:1;display:flex;flex-direction:column;border-radius:12px;overflow:hidden}
    .chat-header{padding:12px;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(255,255,255,0.015));display:flex;align-items:center;justify-content:space-between}
    .chat-body{flex:1;padding:12px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005))}
    .msg{max-width:80%;padding:10px;border-radius:12px}
    .msg.user{align-self:flex-end;background:linear-gradient(90deg,#e0af0d,#e0af0d);color:#022233}
    .msg.bot {
      align-self: flex-start;
      background: linear-gradient(
        180deg,
        rgba(255, 255, 255, 0.06),
        rgba(255, 255, 255, 0.02)
      );
      border: 1px solid rgba(245, 158, 11, 0.25); /* orange accent */
      color: #e5e7eb;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .chat-input{display:flex;gap:8px;padding:10px;background:var(--card);border-top:1px solid rgba(255,255,255,0.02)}
    .chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .quick-actions{display:flex;gap:8px;margin-top:10px}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}

    /* responsive */
    @media (max-width:980px){.app{grid-template-columns:1fr;}.chat-wrap{position:relative;height:auto}} 
  </style>
</head>
<body>
  <div class="app">
    <!-- MAIN -->
    <main>
      <header>
        <div class="logo">
          <img src="/static/logo.png" alt="Legal Clause Analyzer Logo" />
        </div>
        <div>
          <h1>Legal Clause Analyzer</h1>
          <div class="lead">Upload a contract ‚Äî the assistant will find risky clauses and explain what's right or wrong.</div>
        </div>
      </header>

      <section class="panel" style="margin-top:12px;">
        <div class="uploader" role="region" aria-label="upload area">
          <div class="drop" id="dropzone">
            <p id="dropText">üìÅ Choose or drop a file (PDF / TXT)</p>
            <div class="hint">Large text is OK ‚Äî processing may take 10‚Äì30s on CPU.</div>
          </div>

          <div class="right-actions">
            <input id="fileInput" type="file" accept=".pdf,.txt" />
            <button id="chooseBtn" class="btn">Choose file</button>
            <button id="uploadBtn" class="btn primary">Upload & Process</button>
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <label style="color:var(--muted);font-size:13px">Language:</label>
              <select id="langSelect" style="background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit;padding:6px;border-radius:8px">
                <option value="">English</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
              </select>
            </div>
            <div id="statusBox" style="display:none;color:var(--muted);margin-top:6px">Processing‚Ä¶</div>
          </div>
        </div>

        <div id="results" class="results" style="display:none;margin-top:12px"></div>
      </section>

      <!-- helper controls -->
      <section style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="summarizeWrong" class="btn">What's wrong?</button>
        <button id="summarizeRight" class="btn">What's right?</button>
        <div style="flex:1"></div>
        <button id="downloadJson" class="btn">Download JSON</button>
      </section>

    </main>

    <!-- CHAT / ASSISTANT -->
    <aside class="chat-wrap">
      <div class="chat-panel panel">
        <div class="chat-header">
          <div><strong>Assistant</strong><div style="font-size:12px;color:var(--muted)">Ask questions about the uploaded document</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="clearChat" class="small-btn">Clear</button>
            <button id="speakAnswer" class="small-btn">üîä</button>
          </div>
        </div>
        <div id="chatBody" class="chat-body" aria-live="polite"></div>
        <div class="chat-input">
          <input id="chatInput" placeholder="Ask the assistant (e.g. "What happens if seller defaults?")" />
          <button id="chatSend" class="btn primary">Ask</button>
        </div>
        <div class="quick-actions" style="padding:12px">
          <div class="pill" id="quick1">Summarize risks</div>
          <div class="pill" id="quick2">List pro clauses</div>
          <div class="pill" id="quick3">Show refund clauses</div>
        </div>
      </div>
    </aside>
  </div>

<script>
/* Minimal client app ‚Äî dark professional UI + chat + helpers */
(function(){
  const drop = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const chooseBtn = document.getElementById('chooseBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusBox = document.getElementById('statusBox');
  const resultsDiv = document.getElementById('results');
  const downloadJson = document.getElementById('downloadJson');

  const chatBody = document.getElementById('chatBody');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  const clearChat = document.getElementById('clearChat');
  const speakAnswerBtn = document.getElementById('speakAnswer');

  let lastData = null; // store latest upload result

  // UX handlers
  drop.addEventListener('click', ()=> fileInput.click());
  chooseBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', ()=> {
    const f = fileInput.files[0];
    if(f) drop.querySelector('#dropText').textContent = 'üìÅ ' + f.name;
  });

  uploadBtn.addEventListener('click', ()=> {
    if(!fileInput.files.length){alert('Choose a file first');return}
    uploadFile(fileInput.files[0]);
  });

  async function uploadFile(file){
    resultsDiv.style.display='none';
    statusBox.style.display='block';
    statusBox.textContent='Uploading & analysing ‚Äî please wait';

    const fd = new FormData(); fd.append('file', file);
    try{
      const res = await fetch('/upload',{method:'POST',body:fd});
      if(!res.ok){alert('Upload failed');statusBox.style.display='none';return}
      const data = await res.json();
      lastData = data;
      renderResults(data);
    }catch(e){console.error(e);alert('Upload error')}
    finally{statusBox.style.display='none'}
  }

  // render results and attach translate / speak / chat actions
  function renderResults(data){
    resultsDiv.innerHTML=''; resultsDiv.style.display='block';
    // summary
    const sum = document.createElement('div'); sum.className='summary';
    sum.innerHTML = `<div>‚úÖ Clauses found: <strong>${data.num_clauses}</strong></div><div style="display:flex;gap:8px"><button id='downloadBtn' class='btn'>Download JSON</button></div>`;
    resultsDiv.appendChild(sum);
    document.getElementById('downloadBtn').addEventListener('click', ()=>downloadJSON(data));

    data.results.forEach(r=>{
      const clause = (data.clauses||[]).find(c=>c.clause_id===r.clause_id) || {};
      const card = document.createElement('div'); card.className='clause-card panel';

      const meta = document.createElement('div'); meta.className='clause-meta';
      meta.innerHTML = `<div class='clause-id'>${r.clause_id}</div><div class='clause-section'>${clause.section||'Unknown'}</div><div style='margin-top:8px'><span class='label ${r.label.toLowerCase()}'>${r.label}</span></div><div style='margin-top:8px;color:var(--muted);font-size:12px'>${Math.round(r.confidence*100)}%</div>`;

      const body = document.createElement('div'); body.className='clause-body';
      body.innerHTML = `<div><strong>Original:</strong> <div style='margin-top:6px;color:#cfe8ff'>${escapeHtml(r.original||'')}</div></div>`;

      if(r.amended && r.amended !== '[No safe automatic amendment generated]'){
        const am = document.createElement('div'); am.className='amend'; am.innerHTML=`<strong>Suggested amendment:</strong><div style='margin-top:6px'>${escapeHtml(r.amended)}</div>`; body.appendChild(am);
      } else if(r.amended === '[No safe automatic amendment generated]'){
        const am = document.createElement('div'); am.className='amend'; am.innerHTML=`<strong>Suggestion:</strong><div style='margin-top:6px;color:var(--muted)'>No safe auto amendment ‚Äî recommended: expert review.</div>`; body.appendChild(am);
      }

      const tools = document.createElement('div'); tools.className='tools';

      const translateBtn = document.createElement('button'); translateBtn.className='small-btn'; translateBtn.textContent='üåê Translate';
      translateBtn.addEventListener('click', async ()=>{
        const lang = document.getElementById('langSelect').value; if(!lang){alert('Choose a target language first');return}
        translateBtn.disabled=true; translateBtn.textContent='Translating...';
        try{const t = await backendTranslate(r.original, lang); showTranslated(body,t)}catch(e){alert('Translation failed')}
        finally{translateBtn.disabled=false; translateBtn.textContent='üåê Translate'}
      });

      const talkBtn = document.createElement('button'); talkBtn.className='small-btn'; talkBtn.textContent='üîä Read';
      talkBtn.addEventListener('click', ()=>speakText(r.original));

      const askBtn = document.createElement('button'); askBtn.className='small-btn'; askBtn.textContent='üí¨ Ask about';
      askBtn.addEventListener('click', ()=>{pushUserMessage(`Explain clause ${r.clause_id}: ${truncate(r.original,220)}`); sendChatQuestion(`Explain clause ${r.clause_id}:`)});

      tools.appendChild(translateBtn); tools.appendChild(talkBtn); tools.appendChild(askBtn);
      body.appendChild(tools);

      card.appendChild(meta); card.appendChild(body);
      resultsDiv.appendChild(card);
    });

    // focus
    resultsDiv.scrollIntoView({behavior:'smooth'});
  }

  function downloadJSON(data){
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='analysis.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function showTranslated(body, text){ let box = body.querySelector('.translated-box'); if(!box){box=document.createElement('div');box.className='amend translated-box';body.appendChild(box);} box.innerHTML=`<strong>Translated:</strong><div style='margin-top:6px;color:#cfe8ff'>${escapeHtml(text)}</div>` }

  // small helpers
  function escapeHtml(text){ if(!text) return ''; return (''+text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br/>'); }
  function truncate(s,n){return s && s.length>n? s.slice(0,n)+'‚Ä¶': s }

  // chat logic
  function appendMessage(txt, who='bot'){ const d=document.createElement('div'); d.className='msg '+(who==='user'?'user':'bot'); d.innerHTML = txt; chatBody.appendChild(d); chatBody.scrollTop = chatBody.scrollHeight; }
  function pushUserMessage(txt){ appendMessage(escapeHtml(txt),'user'); }

  async function sendChatQuestion(q){
    if(!q) return; appendMessage('<em>Searching‚Ä¶</em>','bot');
    try{
      const res = await fetch('/qa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q})});
      const data = await res.json();
      // remove last 'Searching' placeholder
      if(chatBody.lastChild && chatBody.lastChild.innerText.includes('Searching')) chatBody.removeChild(chatBody.lastChild);

      if(!data.answer){ appendMessage('<strong>No answer found in the document.</strong>'); return }
      // show answer and evidence
      appendMessage(`<strong>${escapeHtml(data.answer)}</strong>`);
      (data.evidence||[]).forEach(ev=>{
        appendMessage(`<div style='font-size:13px;color:var(--muted)'>Ref ${ev.clause_id} ‚Äî score ${Math.round(ev.score*100)}%</div><div style='margin-top:6px;color:#cfe8ff'>${escapeHtml(truncate(ev.text,300))}</div>`);
      });
    }catch(e){ console.error(e); appendMessage('Unable to fetch answer ‚Äî check server logs') }
  }

  chatSend.addEventListener('click', ()=>{ const q=chatInput.value.trim(); if(!q) return; pushUserMessage(q); chatInput.value=''; sendChatQuestion(q); });
  chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') chatSend.click(); });
  clearChat.addEventListener('click', ()=>{ chatBody.innerHTML=''; appendMessage('<strong>Hello ‚Äî I can answer questions about the uploaded document. Try: "What happens if seller defaults?"</strong>'); });

  // quick action buttons
  document.getElementById('quick1').addEventListener('click', ()=>{ if(!lastData) return alert('Upload a document first'); const q = summarizeByLabel('Con'); pushUserMessage('Summarize risks:'); sendChatQuestion(q); });
  document.getElementById('quick2').addEventListener('click', ()=>{ if(!lastData) return alert('Upload a document first'); const q = summarizeByLabel('Pro'); pushUserMessage('List favorable clauses:'); sendChatQuestion(q); });
  document.getElementById('quick3').addEventListener('click', ()=>{ if(!lastData) return alert('Upload a document first'); const q = findKeywordClauses('return the whole advance'); pushUserMessage('Find refund clauses:'); sendChatQuestion(q); });

  document.getElementById('summarizeWrong').addEventListener('click', ()=>{ if(!lastData) return alert('Upload a document first'); const text = summarizeByLabel('Con'); // show quick in chat
    pushUserMessage('What are the main risks?'); sendChatQuestion(text);
  });
  document.getElementById('summarizeRight').addEventListener('click', ()=>{ if(!lastData) return alert('Upload a document first'); const text = summarizeByLabel('Pro'); pushUserMessage('What protections exist in the contract?'); sendChatQuestion(text);
  });

  function summarizeByLabel(label){ if(!lastData) return 'No document uploaded'; const hits = lastData.results.filter(r=>r.label===label); if(!hits.length) return `No ${label} clauses found.`; return hits.map(r=>`Clause ${r.clause_id}: ${truncate(r.original,180)}`).join('\n\n'); }
  function findKeywordClauses(keyword){ if(!lastData) return 'No document uploaded'; const hits = lastData.results.filter(r=> (r.original||'').toLowerCase().includes(keyword.toLowerCase())); if(!hits.length) return `No clauses mentioning ${keyword}`; return hits.map(r=>`Clause ${r.clause_id}: ${truncate(r.original,220)}`).join('\n\n'); }

  // translation helper (calls backend /translate)
  async function backendTranslate(text,target){ const res = await fetch('/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, target})}); if(!res.ok) throw new Error('Translation failed'); const d=await res.json(); return d.translatedText }

  // TTS helper
  async function speakText(text){ try{ const lang = document.getElementById('langSelect').value || 'en'; const res = await fetch('/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text, lang})}); if(!res.ok) throw new Error('TTS failed'); const blob = await res.blob(); const url = URL.createObjectURL(blob); const audio = new Audio(url); audio.play(); audio.onended = ()=>URL.revokeObjectURL(url); }catch(e){ alert('Audio unavailable'); console.error(e);} }

  // initial assistant greeting
  appendMessage('<strong>Hello ‚Äî I can explain clauses and point out risks. Upload a document to get started.</strong>');

  // expose some functions to console for debugging
  window.backendTranslate = backendTranslate; window.speakText = speakText; window.lastData = () => lastData;

})();
</script>
</body>
</html>
